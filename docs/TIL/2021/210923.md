# 2021.09.23 TIL

- google의 WebP
- 비디오 코덱
- img2webp
- cwebp
- 그리고 반전...
- 정리

## Google WebP
- docs: https://developers.google.com/speed/webp
- Google에서 이미지 압축을 되게 효율적으로 작게 만들어서 많이 쓰인다고 한다.
- c 기반으로 개발되어서 오픈소스를 가서 보면 make 빌드가 가능하다.
- 이걸 Java에서 쓰기 위해 뭐 다양한 방법이 있겠지만, 첫 시도에서 동적 라이브러리 파일로 빌드해보려다가 번번히 실패했다. (.dll, .so, .dylib 등)
- 그래서 단순하게 머리를 비우고 실행파일로 빌드된 프로그램 중에 img2webp와 cwebp를 활용해 썸네일 만들기를 진행해봤다.

## 비디오 코덱
- 가끔 영화를 다운받아서 볼 때나 확인하던 코덱이라는 용어가 튀어나왔다.
- 동영상에서 사진을 프레임 단위로 capture 하기 위해서 비디오를 프레임 단위로 나눌 수 있는 영상으로 **변환**하는 단계가 필요했는데, 이 때 사용되는 기술이 video codec 이다.
- https://ko.wikipedia.org/wiki/영상_코덱
- 위의 링크에서도 영상 코덱으로 위키백과를 찾아보면 가장 흔히 쓰이는 영상 코덱이 나오는데, 이중에서도 가장 많이 들어본 H.264를 이용해보았다.
- java에서는 jcodec이라고 하는 오픈소스에서 H.264 인코딩을 지원하기 때문에 이를 사용하려고 했는데 이미지를 다시 변환하여 영상으로 만드는 것까지는 좋았는데, 음성을 새로 변환한 영상에 넣을수가 없었다...
- https://github.com/jcodec/jcodec
- jcodec 깃허브에 가보면 Future development로 Audio에 대한 얘기가 적혀있을 뿐 아직 진행된 부분은 아닌듯 하다.
- 결국 '**ffmpeg**'이라는 이름의 가장 대중적이고 많이 사용되는 프로그램을 통해 명령어를 입력하게 하여 동작시켰다.

## img2webp
- 그렇게 변환된 동영상에서 원래 하고자 했던 Youtube에서 보았던 움직이는 썸네일을 구현해보고자 WebP의 라이브러리 중 img2webp라는 것을 사용하게 되었다.
- 동영상에서 일정 시간 동안 프레임 이미지를 png 형태로 추출하여서 각각의 이미지마다 시간 간격을 주어 동영상처럼 움직이는 썸네일을 만들 수가 있었다.
- 하지만 webp를 사용하는 가장 큰 이유가 압축률이 뛰어나 결과물 용량이 적어야하는데 그렇지가 않았다.
- 여기서 내가 간과한 부분은 **동영상에서 추출한 이미지를 resizing 하지 않았다는 점**과 그렇게 해서 만들어진 **이미지를 각각 webp로 변환하지 않고 png 이미지들을 모아 움직이는 사진을 만드려고 했다는 점**이다.
- 이를 보완했던 과정은 https://github.com/boring-km/video-webp-thumbnail/commits/main에 기록되어 있다.

## cwebp
- 위에서 말한 부분 중 이미지를 각각 webp로 변환하는 것에 있어서 이미지 하나를 webp로 변환해주는 라이브러리이다.

## 그리고 반전...
- 이 글들을 정리하면서 다시 알게 된 사실이지만, 조금 전 img2webp에서 설명했던 간과한 부분 2번째에 대한 cwebp의 용도가 사라져버렸다.
- img2webp에서 각 이미지 별로 compression을 해주는 옵션이 이미 효과적으로 파일 용량을 줄여주고 있었다!
- 오히려 png에서 webp로 변환했다가 webp들을 합쳐서 압축 옵션을 사용해 animated webp를 만드는 것보다 png에서 바로 animated webp를 만들 때 압축 옵션을 사용하는 것이 더 적은 용량의 결과물이 나왔다.

### 정리
- 움직이는 썸네일(animated thumbnail)을 만들 때는 원하는 영상을 편집 가능하도록 인코딩 한 후에 img2webp를 사용하면 된다. 