# 0819 TIL
- Node.js와 Express, Mongo DB를 활용한 초간단 주소록 예제
- Node.js 콜백 패턴

### 1. 주소록 예제
- 원본: https://www.a-mean-blog.com/ko/blog/Node-JS-%EC%B2%AB%EA%B1%B8%EC%9D%8C/%EC%A3%BC%EC%86%8C%EB%A1%9D-%EB%A7%8C%EB%93%A4%EA%B8%B0
- DB 기본 Setting
  1. MongoDB Atlas에 Google 로그인해서 가입
  2. 프로젝트 생성
  3. 무료버전 클러스터 이용
  4. User Name/PW 설정
  5. Network Access 설정(0.0.0.0/0 하면 전체 허용)
  6. Clusters -> CONNECT -> Connect Your Application -> Connection String Only 복사
  7. 시스템 환경 변수에 MONGO_DB로 복사한 값을 설정함
- 프로젝트 폴더 생성 후 npm init으로 기본 node.js 프로젝트 생성
- npm install --save ejs express mongoose body-parser method-override
- 프로젝트 폴더 구조
  ```bash
  Node-ContactBook
  │  .gitignore
  │  index.js
  │  package-lock.json
  │  package.json
  │  
  ├─database
  │      db.js
  │      
  ├─models
  │      Contact.js
  │      
  ├─node_modules
  │          
  ├─public
  │  └─css
  │          master.css
  │          
  ├─routes
  │      contacts.js
  │      home.js
  │      
  └─views
      ├─contacts
      │      edit.ejs
      │      index.ejs
      │      new.ejs
      │      show.ejs
      │      
      └─partials
              head.ejs
              nav.ejs
  ```
- ejs는 따로 설명하지 않음

#### 기본 세팅
  ```javascript
  // index.js
  var express = require('express');
  var bodyParser = require('body-parser');
  var methodOverride = require('method-override');  // query로 method값을 받아서 request의 HTTP method를 바꿔주는 역할
  var app = express();

  // DB Setting
  require('./database/db')();

  app.set('view engine', 'ejs');
  app.use(express.static(__dirname + '/public'));
  app.use(bodyParser.json());
  app.use(bodyParser.urlencoded({ extended: true }));
  app.use(methodOverride('_method'));

  // Routes
  app.use('/', require('./routes/home'));
  app.use('/contacts', require('./routes/contacts'));
  
  // Port Setting
  app.listen(port, function() {
    console.log('server on! http://localhost:' + port);
  });
  ```
- DB 세팅(mongoose 사용)
  ```javascript
  // database/db.js
  var mongoose = require('mongoose');
  mongoose.set('useNewUrlParser', true);
  mongoose.set('useFindAndModify', false);
  mongoose.set('useCreateIndex', true);
  mongoose.set('useUnifiedTopology', true);
  mongoose.connect(process.env.MONGO_DB);

  var db = mongoose.connection;
  db.once('open', () => console.log('DB connected'));
  db.on('error', err => console.log('DB ERROR : ', err));
  ```

#### MongoDB 스키마 생성
```javascript
// models/Contact.js
var mongoose = require('mongoose');

// DB schema
var contactSchema = mongoose.Schema({
    name:{type:String, required:true, unique:true},
    email:{type:String},
    phone:{type:String}
  });

module.exports = mongoose.model('contact', contactSchema);
```

#### Router
- 참고한 블로그(Express): https://backback.tistory.com/341
```javascript
var app = express();    // Application Level MiddleWare
var route = express.Router();      // Router Level MiddleWare
```
- 첫 번째 인자로 주소를 받아서 특정 주소에 해당하는 요청이 왔을 때만 미들웨어가 동작하게 할 수 있다.
- 뭔가 특별한 기능이 더 있다기 보다는 코드 관리를 위해서 라우터를 별도로 분리하는데 그 의미가 있다.
```javascript
var express = require('express');
var router = express.Router();
var Contact = require('../models/Contact');
// GET
router.get('/', function (req, res) {
    Contact.find({}, function (err, contacts) {
        if (err) return res.json(err);
        res.render('contacts/index', { contacts: contacts });
    });
});
// POST
router.post('/', function (req, res) {
    Contact.create(req.body, function (err, contact) {
        if (err) return res.json(err);
        res.redirect('/contacts');
    });
});
// PUT
router.put('/:id', function (req, res) {
    Contact.findOneAndUpdate({ _id: req.params.id }, req.body, function (err, contact) {
        if (err) return res.json(err);
        res.redirect('/contacts/' + req.params.id);
    });
});
// DELETE
router.delete('/:id', function (req, res) {
    Contact.deleteOne({ _id: req.params.id }, function (err) {
        if (err) return res.json(err);
        res.redirect('/contacts');
    });
});
```

### 2. Node.js 콜백 패턴
- 작업 결과를 전달하기 위해 호출되는 함수
- 비동기 작업을 처리할 때 반드시 필요하다.
- 항상 동기적으로 실행되는 return 명령의 사용을 대신함
- 클로저(closures)를 통해 콜백을 구현하는 방법도 있다.
- 클로저 관련 URL: https://developer.mozilla.org/ko/docs/Web/JavaScript/Guide/Closures

#### 2.1 연속 전달 방식(The Continuation-Passing Style)
- 콜백은 다른 함수에 인수로 전달되는 함수이며, 작업이 완료되면 결과로 호출된다.